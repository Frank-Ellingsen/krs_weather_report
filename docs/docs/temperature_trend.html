<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Temperature Decomposition</title>

    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7f9fc;
        margin: 0;
        padding: 1.5rem;
      }

      h2 {
        text-align: center;
        margin-bottom: 0.25rem;
      }

      .subtitle {
        text-align: center;
        color: #555;
        margin-bottom: 2rem;
        font-size: 0.9rem;
      }

      .chart {
        width: 100%;
        max-width: 1100px;
        height: 280px;
        margin: 0 auto 2rem auto;
      }
    </style>
  </head>

  <body>
    <h2>üå°Ô∏è Temperature Time Series Decomposition</h2>
    <div class="subtitle">
      Observed ¬∑ Trend (100-record MA) ¬∑ Seasonality ¬∑ Noise
    </div>

    <div id="observed" class="chart"></div>
    <div id="trend" class="chart"></div>
    <div id="seasonal" class="chart"></div>
    <div id="residual" class="chart"></div>

    <script>
      /* ===============================
   Helper functions (ONE TIME)
================================ */

      // Moving average
      function movingAverage(values, window) {
        return values.map((_, i, arr) => {
          if (i < window - 1) return null;
          const slice = arr.slice(i - window + 1, i + 1);
          return slice.reduce((a, b) => a + b, 0) / slice.length;
        });
      }

      // Seasonal component (average cycle)
      function seasonalComponent(values, period) {
        const seasonal = new Array(values.length).fill(null);
        const seasonAverages = Array(period).fill(0);
        const seasonCounts = Array(period).fill(0);

        values.forEach((v, i) => {
          if (v !== null) {
            const idx = i % period;
            seasonAverages[idx] += v;
            seasonCounts[idx]++;
          }
        });

        for (let i = 0; i < period; i++) {
          seasonAverages[i] /= seasonCounts[i] || 1;
        }

        return seasonal.map((_, i) => seasonAverages[i % period]);
      }

      /* ===============================
   Load full dataset
================================ */

      fetch('data/weather_data.json')
        .then((res) => res.json())
        .then((data) => decomposeAndRender(data));

      /* ===============================
   Decompose & render
================================ */

      function decomposeAndRender(data) {
        const dates = data.map((d) => d.timestamp);
        const temps = data.map((d) => d.temperature);

        const trend = movingAverage(temps, 100);

        const detrended = temps.map((v, i) =>
          trend[i] !== null ? v - trend[i] : null
        );

        // Period = 365 if daily, adjust if hourly
        const seasonal = seasonalComponent(detrended, 365);

        const residual = temps.map((v, i) =>
          trend[i] !== null && seasonal[i] !== null
            ? v - trend[i] - seasonal[i]
            : null
        );

        plotSeries('observed', dates, temps, 'Observed Temperature', '#4c78a8');
        plotSeries(
          'trend',
          dates,
          trend,
          'Trend (100-record Moving Average)',
          '#e45756'
        );
        plotSeries('seasonal', dates, seasonal, 'Seasonality', '#72b7b2');
        plotSeries('residual', dates, residual, 'Residual / Noise', '#999999');
      }

      /* ===============================
   Plot helper
================================ */

      function plotSeries(divId, x, y, title, color) {
        Plotly.newPlot(
          divId,
          [
            {
              x,
              y,
              mode: 'lines',
              line: { color, width: 2 },
              hovertemplate: '%{y:.2f} ¬∞C<br>%{x}<extra></extra>',
            },
          ],
          {
            title: { text: title, font: { size: 14 } },
            margin: { t: 40, l: 60, r: 30, b: 40 },
            xaxis: { showgrid: false },
            yaxis: { zeroline: false },
            hovermode: 'x unified',
          },
          {
            responsive: true,
            displayModeBar: false,
          }
        );
      }
    </script>
  </body>
</html>
